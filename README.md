# Casino Backend

A production-grade mini-casino backend with multi-asset balances and 9 simple games, featuring provably fair gaming, deposit webhooks, and a clean REST API.

## Features

- **Multi-Currency Support**: BTC, ETH, SOL, USDC, USDT with proper decimal handling
- **Provably Fair Gaming**: Commitment scheme with server/client seeds and verification
- **9 Casino Games**: Candle Flip, Pump or Dump, Support/Resistance, Bull vs Bear Battle, Leverage Ladder, Stop Loss Roulette, Freeze the Bag, To the Moon, Diamond Hands
- **Double-Entry Ledger**: Custodial wallet system with full transaction history
- **Demo Mode**: Faucet functionality for testing with demo funds
- **JWT Authentication**: Access and refresh tokens with optional OAuth stubs
- **REST API**: Clean, documented API with Swagger/OpenAPI
- **Docker Support**: Complete containerization with PostgreSQL and Redis

## Tech Stack

- **Language**: TypeScript
- **Framework**: NestJS
- **Database**: PostgreSQL with Prisma ORM
- **Cache/Queue**: Redis
- **Testing**: Jest
- **Authentication**: JWT (access + refresh)
- **Logging**: Pino
- **Rate Limiting**: Built-in throttling
- **Documentation**: Swagger/OpenAPI

## Quick Start

### Prerequisites

- Node.js 18+
- Docker and Docker Compose
- PostgreSQL 15+
- Redis 7+

### Installation

1. **Clone and install dependencies**:
   ```bash
   git clone <repository-url>
   cd casino
   npm install
   ```

2. **Set up environment**:
   ```bash
   cp env.example .env
   # Edit .env with your configuration
   ```

3. **Start services with Docker**:
   ```bash
   docker-compose up -d
   ```

4. **Run database migrations**:
   ```bash
   npx prisma migrate dev
   ```

5. **Seed the database**:
   ```bash
   npm run prisma:seed
   ```

6. **Start the development server**:
   ```bash
   npm run start:dev
   ```

The API will be available at `http://localhost:3000/api/v1` and Swagger documentation at `http://localhost:3000/docs`.

## API Endpoints

### Authentication
- `POST /auth/register` - Register new user
- `POST /auth/login` - Login user
- `POST /auth/refresh` - Refresh access token
- `GET /auth/me` - Get current user info

### Wallets
- `GET /wallets` - Get all wallet balances
- `GET /wallets/balance` - Get balance for specific currency
- `POST /wallets/faucet` - Get demo funds (demo mode only)
- `GET /wallets/ledger` - Get ledger entries

### Games
- `GET /games` - Get all available games
- `GET /games/:game` - Get game configuration

### Bets
- `POST /bets/preview` - Preview bet (calculate potential payout)
- `POST /bets/place` - Place a bet
- `POST /bets/resolve/:id` - Resolve bet (admin only)
- `POST /bets/cashout/:id` - Cash out bet (crash games)
- `GET /bets/:id` - Get bet details
- `GET /bets` - Get user bets

### Fairness
- `GET /fairness/seed/current` - Get current fairness seed
- `POST /fairness/seed/rotate` - Rotate fairness seed (admin)
- `POST /fairness/seed/reveal` - Reveal fairness seed (admin)
- `POST /fairness/verify` - Verify fairness of a bet

### Deposits
- `POST /deposits` - Create deposit request
- `POST /deposits/provider/webhook` - Process provider webhook
- `GET /deposits` - Get user deposits

### Withdrawals
- `POST /withdrawals` - Create withdrawal request
- `GET /withdrawals` - Get user withdrawals
- `GET /withdrawals/pending` - Get pending withdrawals (admin)

### Leaderboard
- `GET /leaderboard/daily` - Get daily leaderboard
- `GET /leaderboard/position` - Get user position
- `GET /leaderboard/history` - Get user history

## Games

### 1. Candle Flip
Predict the next candle color (red/green)
- **Win Chance**: 49.5%
- **Multiplier**: 1.98x
- **House Edge**: 1%

### 2. Pump or Dump
Predict if price goes up or down
- **Win Chance**: 49.5%
- **Multiplier**: 1.98x
- **House Edge**: 1%

### 3. Support or Resistance
Predict if price breaks or rejects a level
- **Win Chance**: 48.5%
- **Multiplier**: 2.02x
- **House Edge**: 3%

### 4. Bull vs Bear Battle
Tug-of-war bar direction
- **Win Chance**: 49%
- **Multiplier**: 2.0x
- **House Edge**: 2%

### 5. Leverage Ladder
Press to advance rungs with increasing multipliers
- **Multipliers**: [1.3, 1.69, 2.19, 2.85, 3.7, 4.8]
- **House Edge**: 2%

### 6. Stop Loss Roulette
Set stop loss distance for dynamic payout
- **Max Multiplier**: 4.0x
- **House Edge**: 2%

### 7. Freeze the Bag
Click to cash before crash
- **Crash Probability**: 1% per step
- **House Edge**: 2%

### 8. To the Moon
Classic crash game
- **Crash Probability**: 1% per step
- **House Edge**: 2%

### 9. Diamond Hands
Mines replica with 5x5 grid
- **Grid Size**: 25
- **Default Mines**: 3
- **House Edge**: 2%

## Provably Fair System

The system uses a commitment scheme for provably fair gaming:

1. **Server Seed**: Secret seed generated by the server
2. **Server Seed Hash**: Public hash of the server seed (commitment)
3. **Client Seed**: User-provided or randomly generated seed
4. **Nonce**: Incremental counter for each bet

### Verification Process

1. Server generates a secret seed and publishes its hash
2. User places bet with their client seed
3. Server reveals the original seed after bet resolution
4. Anyone can verify the outcome using the seeds and nonce

### RNG Generation

```typescript
result = HMAC_SHA256(serverSeed, clientSeed:nonce)
```

The result is mapped to game outcomes deterministically.

## Demo Mode

When `DEMO_MODE=true` in environment variables:

- Faucet is enabled for getting demo funds
- All currencies have daily faucet limits
- Withdrawals are automatically rejected
- Perfect for testing and development

## Environment Variables

See `env.example` for all available configuration options:

- Database connection
- JWT secrets and expiration
- Redis configuration
- Demo mode settings
- Rate limiting
- CORS origins
- Webhook secrets

## Development

### Running Tests

```bash
npm run test
npm run test:watch
npm run test:cov
```

### Database Management

```bash
# Generate Prisma client
npm run prisma:generate

# Run migrations
npm run prisma:migrate

# Seed database
npm run prisma:seed

# Open Prisma Studio
npm run prisma:studio
```

### Code Quality

```bash
# Lint code
npm run lint

# Format code
npm run format
```

## Docker

### Development

```bash
docker-compose up -d
```

### Production

```bash
docker-compose -f docker-compose.prod.yml up -d
```

## API Examples

See `examples.http` for comprehensive API usage examples including:

- Authentication flow
- Placing bets for all games
- Wallet management
- Fairness verification
- Deposit/withdrawal flows

## Security Features

- JWT authentication with refresh tokens
- Rate limiting on all endpoints
- CORS protection
- Helmet security headers
- Input validation with class-validator
- SQL injection protection via Prisma
- XSS protection

## Monitoring

- Health check endpoint at `/health`
- Structured logging with Pino
- Error tracking and reporting
- Performance monitoring hooks

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests
5. Submit a pull request

## License

This project is licensed under the ISC License.

## Support

For questions or issues, please open a GitHub issue or contact the development team.
